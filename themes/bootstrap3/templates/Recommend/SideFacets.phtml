<?
  $this->headScript()->appendFile('facets.js');

  $results = $this->recommend->getResults();
  $options = $this->searchOptions($this->searchClassId);
?>
<? if ($results->getResultTotal() > 0): ?>
  <h4><?=$this->transEsc(isset($this->overrideSideFacetCaption) ? $this->overrideSideFacetCaption : 'Narrow Search')?></h4>
<? endif; ?>
<? $checkboxFilters = $results->getParams()->getCheckboxFacets(); ?>
<? if (count($checkboxFilters) > 0):
    $checkboxesShown = false;
    foreach ($checkboxFilters as &$current) {
      if ($results->getResultTotal() < 1 && !$current['selected'] && !$current['alwaysVisible']) {
        $current['shown'] = false;
      } else {
        $checkboxesShown = true;
        $current['shown'] = true;
      }
    }
  ?>
  <div class="checkboxFilter<?if(!$checkboxesShown):?> hidden<? endif; ?>">
    <? foreach ($checkboxFilters as $current): ?>
      <label class="checkbox<? if(!$current['shown']): ?> hidden<? endif; ?>">
        <input type="checkbox" name="filter[]"
          value="<?=$this->escapeHtmlAttr($current['filter']) ?>"
          <?=$current['selected'] ? ' checked="checked"' : '' ?>
          id="<?=$this->escapeHtmlAttr(str_replace(' ', '', $current['desc'])) ?>"
          onclick="document.location.href='<?=$current['selected'] ? $results->getUrlQuery()->removeFilter($current['filter']) : $results->getUrlQuery()->addFilter($current['filter']);?>'" />
        <?=$this->transEsc($current['desc']) ?>
      </label>
    <? endforeach; ?>
  </div>
<? endif; ?>
<? $extraFilters = isset($this->extraSideFacetFilters) ? $this->extraSideFacetFilters : []; ?>
<? $collapsedFacets = $this->recommend->getCollapsedFacets() ?>
<? $filterList = array_merge($results->getParams()->getFilterList(true), $extraFilters); ?>
<? if (!empty($filterList)): ?>
  <div class="list-group filters">
    <div class="list-group-item title"><?=$this->transEsc('Remove Filters')?></div>
    <? foreach ($filterList as $field => $filters): ?>
      <? foreach ($filters as $i => $filter): ?>
        <?
          $index = isset($filter['field']) ? array_search($filter['field'], $collapsedFacets) : false;
          if ($index !== false) {
            unset($collapsedFacets[$index]); // Open if we have a match
          }
          if (isset($filter['specialType']) && $filter['specialType'] == 'keyword') {
            $removeLink = $this->currentPath() . $results->getUrlQuery()->replaceTerm($filter['value'], '');
          } else {
            $removeLink = $this->currentPath() . $results->getUrlQuery()->removeFacet($filter['field'], $filter['value'], $filter['operator']);
          }
          if ($filter['displayText'] == '[* TO *]') {
            $filter['displayText'] = $this->translate('filter_wildcard');
          }
        ?>
        <a class="list-group-item active" href="<?=$removeLink ?>" title="<?=$this->transEsc('clear_tag_filter') ?>">
          <span class="pull-right flip"><i class="fa fa-times" aria-hidden="true"></i></span>
          <? if ($filter['operator'] == 'NOT'): ?><?=$this->transEsc('NOT') ?><? endif; ?>
          <? if ($filter['operator'] == 'OR' && $i > 0): ?><?=$this->transEsc('OR') ?><? endif; ?>
          <?=$this->transEsc($field) ?>: <?=$this->escapeHtml($filter['displayText']) ?>
        </a>
      <? endforeach; ?>
    <? endforeach; ?>
  </div>
<? endif; ?>
<?= isset($this->sideFacetExtraControls) ? $this->sideFacetExtraControls : '' ?>
<? $sideFacetSet = $this->recommend->getFacetSet(); $rangeFacets = $this->recommend->getAllRangeFacets(); ?>
<? $hierarchicalFacets = $this->recommend->getHierarchicalFacets() ?>
<? $hierarchicalFacetSortOptions = $this->recommend->getHierarchicalFacetSortOptions() ?>
<? if (!empty($sideFacetSet) && $results->getResultTotal() > 0): ?>
  <? foreach ($sideFacetSet as $title => $cluster): ?>
    <? $contextVars = [
      'options' => $options,
      'allowExclude' => $this->recommend->excludeAllowed($title),
      'facets_before_more' => $this->recommend->getShowMoreSetting($title),
      'showMoreInLightbox' => $this->recommend->getShowInLightboxSetting($title)
    ]; ?>
    <div class="list-group facet" id="side-panel-<?=$this->escapeHtmlAttr($title) ?>">
      <div class="list-group-item title<? if(in_array($title, $collapsedFacets)): ?> collapsed<? endif ?>" data-toggle="collapse" href="#side-collapse-<?=$this->escapeHtmlAttr($title) ?>" >
        <?=$this->transEsc($cluster['label'])?>
      </div>
      <div id="side-collapse-<?=$this->escapeHtmlAttr($title) ?>" class="collapse<? if(!in_array($title, $collapsedFacets)): ?> in<? endif ?>">
        <? if (isset($rangeFacets[$title])): ?>
          <?=$this->context($this)->renderInContext('SideFacets/range-slider.phtml', ['title' => $title, 'facet' => $rangeFacets[$title]]); ?>
        <? else: ?>
          <? if (in_array($title, $hierarchicalFacets)): ?>
            <?=$this->context($this)->renderInContext('SideFacets/hierarchical-facets.phtml', ['title' => $title, 'sortOptions' => $hierarchicalFacetSortOptions[$title]]); ?>
            <noscript>
          <? endif; ?>
          <?=$this->context($this)->renderInContext('SideFacets/cluster-list.phtml', array_merge($contextVars, ['title' => $title, 'cluster' => $cluster])); ?>
          <? if (in_array($title, $hierarchicalFacets)): ?>
            </noscript>
          <? endif; ?>
        <? endif; ?>
      </div>
    </div>
  <? endforeach; ?>
<? endif; ?>
